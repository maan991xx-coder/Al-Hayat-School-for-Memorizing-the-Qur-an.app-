import pandas as pd
import streamlit as st
from datetime import datetime

class QuranSchoolSystem:
    def __init__(self):
        self.initialize_storage()
    
    def initialize_storage(self):
        if 'students_df' not in st.session_state:
            st.session_state.students_df = pd.DataFrame(columns=[
                'Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', 
                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©', 'Ø¹Ø¯Ø¯_Ø§Ù„Ù…Ù„ÙØ§Øª', 
                'Ø£ÙˆÙ„_Ø¸Ù‡ÙˆØ±', 'Ø¢Ø®Ø±_Ø¸Ù‡ÙˆØ±', 'Ø­Ø§Ù„Ø©_Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…'
            ])
        if 'uploaded_files' not in st.session_state:
            st.session_state.uploaded_files = []
    
    def upload_file(self, uploaded_file):
        try:
            df = pd.read_excel(uploaded_file)
            self.update_students_data(df, datetime.now().strftime("%Y%m%d_%H%M%S"))
            st.session_state.uploaded_files.append(uploaded_file.name)
            return True, "ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ù„ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­"
        except Exception as e:
            return False, f"Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: {str(e)}"
    
    def update_students_data(self, new_data, file_timestamp):
        students_df = st.session_state.students_df
        
        for index, row in new_data.iterrows():
            student_name = row.iloc[0]
            
            if not students_df.empty and student_name in students_df['Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨'].values:
                student_index = students_df[students_df['Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨'] == student_name].index[0]
                students_df.at[student_index, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©'] += row.iloc[2] if pd.notna(row.iloc[2]) else 0
                students_df.at[student_index, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©'] += row.iloc[1] if pd.notna(row.iloc[1]) else 0
                students_df.at[student_index, 'Ø¹Ø¯Ø¯_Ø§Ù„Ù…Ù„ÙØ§Øª'] += 1
                students_df.at[student_index, 'Ø¢Ø®Ø±_Ø¸Ù‡ÙˆØ±'] = file_timestamp
            else:
                new_student = {
                    'Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨': student_name,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©': row.iloc[2] if pd.notna(row.iloc[2]) else 0,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©': row.iloc[1] if pd.notna(row.iloc[1]) else 0,
                    'Ø¹Ø¯Ø¯_Ø§Ù„Ù…Ù„ÙØ§Øª': 1,
                    'Ø£ÙˆÙ„_Ø¸Ù‡ÙˆØ±': file_timestamp,
                    'Ø¢Ø®Ø±_Ø¸Ù‡ÙˆØ±': file_timestamp,
                    'Ø­Ø§Ù„Ø©_Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…': 'Ù†Ø´Ø·'
                }
                students_df = pd.concat([students_df, pd.DataFrame([new_student])], ignore_index=True)
        
        st.session_state.students_df = students_df

def main():
    st.set_page_config(page_title="Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­ÙŠØ§Ø© Ù„ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†", page_icon="ğŸ“–", layout="wide")
    st.title("ğŸ“– Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­ÙŠØ§Ø© Ù„ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…")
    st.markdown("---")
    
    system = QuranSchoolSystem()
    
    st.sidebar.title("Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©")
    menu = st.sidebar.radio("Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:", [
        "ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
        "ğŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨", 
        "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬",
        "ğŸ‘¨â€ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨",
        "â­ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù„ØªØ²Ù…ÙŠÙ†"
    ])
    
    if menu == "ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©":
        st.header("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©")
        st.info("""
        **Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:**
        - Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Excel Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
        - ØªØ­Ù„ÙŠÙ„ ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„ØªÙ„Ø§ÙˆØ© ÙˆØ§Ù„Ø­ÙØ¸
        - Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù„ØªØ²Ù…ÙŠÙ†
        - ØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØµÙ„Ø© Ø¹Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡
        """)
        
    elif menu == "ğŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨":
        st.header("Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Excel")
        uploaded_file = st.file_uploader("Ø§Ø®ØªØ± Ù…Ù„Ù Excel", type=['xlsx', 'xls'])
        
        if uploaded_file is not None:
            if st.button("Ø±ÙØ¹ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù"):
                with st.spinner('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...'):
                    success, message = system.upload_file(uploaded_file)
                    if success:
                        st.success(message)
                        st.balloons()
                    else:
                        st.error(message)
            
            df = pd.read_excel(uploaded_file)
            st.subheader("Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:")
            st.dataframe(df.head())
    
    elif menu == "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬":
        st.header("ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø£ÙˆØ§Ø¦Ù„")
        
        if st.session_state.students_df.empty:
            st.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„")
        else:
            col1, col2 = st.columns(2)
            
            with col1:
                st.subheader("ğŸ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙÙŠ Ø§Ù„ØªÙ„Ø§ÙˆØ©")
                top_recitation = st.session_state.students_df.nlargest(5, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©')
                for i, (_, row) in enumerate(top_recitation.iterrows(), 1):
                    st.write(f"{i}. **{row['Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨']}** - {row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©']} ØµÙØ­Ø©")
            
            with col2:
                st.subheader("ğŸ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸")
                top_memorization = st.session_state.students_df.nlargest(5, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©')
                for i, (_, row) in enumerate(top_memorization.iterrows(), 1):
                    st.write(f"{i}. **{row['Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨']}** - {row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©']} ØµÙØ­Ø©")
    
    elif menu == "ğŸ‘¨â€ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨":
        st.header("Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨")
        
        if st.session_state.students_df.empty:
            st.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ù„Ø§Ø¨")
        else:
            student_name = st.text_input("Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨:")
            
            if student_name:
                student_data = st.session_state.students_df[
                    st.session_state.students_df['Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨'].str.contains(student_name, na=False)
                ]
                
                if not student_data.empty:
                    student = student_data.iloc[0]
                    st.success(f"Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: **{student['Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨']}**")
                    
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.metric("Ø§Ù„Ù…Ù„ÙØ§Øª", f"{student['Ø¹Ø¯Ø¯_Ø§Ù„Ù…Ù„ÙØ§Øª']} Ù…Ù„Ù")
                    with col2:
                        st.metric("Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©", f"{student['Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©']} ØµÙØ­Ø©")
                    with col3:
                        st.metric("Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©", f"{student['Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©']} ØµÙØ­Ø©")
                else:
                    st.error("Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
            
            st.subheader("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨")
            st.dataframe(st.session_state.students_df)
    
    elif menu == "â­ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù„ØªØ²Ù…ÙŠÙ†":
        st.header("Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù„ØªØ²Ù…ÙŠÙ†")
        
        if st.session_state.students_df.empty or len(st.session_state.uploaded_files) == 0:
            st.warning("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©")
        else:
            total_files = len(st.session_state.uploaded_files)
            committed_students = st.session_state.students_df[
                st.session_state.students_df['Ø¹Ø¯Ø¯_Ø§Ù„Ù…Ù„ÙØ§Øª'] == total_files
            ]
            
            if committed_students.empty:
                st.info("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ù„ØªØ²Ù…ÙŠÙ† Ø¸Ù‡Ø±ÙˆØ§ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª")
            else:
                committed_students = committed_students.nlargest(10, 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©')
                st.success(f"Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù„ØªØ²Ù…ÙŠÙ† (Ø¸Ù‡Ø±ÙˆØ§ ÙÙŠ Ø¬Ù…ÙŠØ¹ {total_files} Ù…Ù„ÙØ§Øª)")
                
                for i, (_, row) in enumerate(committed_students.iterrows(), 1):
                    with st.expander(f"ğŸ… {row['Ø§Ø³Ù…_Ø§Ù„Ø·Ø§Ù„Ø¨']}"):
                        col1, col2 = st.columns(2)
                        with col1:
                            st.write(f"**Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:** {row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©']}")
                            st.write(f"**Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©:** {row['Ø¥Ø¬Ù…Ø§Ù„ÙŠ_Ø§Ù„ØµÙØ­Ø§Øª_Ø§Ù„Ù…Ù‚Ø±Ø¤Ø©']}")
                        with col2:
                            st.write(f"**Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±:** {row['Ø£ÙˆÙ„_Ø¸Ù‡ÙˆØ±']}")
                            st.write(f"**Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±:** {row['Ø¢Ø®Ø±_Ø¸Ù‡ÙˆØ±']}")

if __name__ == "__main__":
    main()
